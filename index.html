<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Famille Connect Pro - Version Connect√©e</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .connection-setup {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
            text-align: center;
        }

        .family-code-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
        }

        .family-code-input input {
            padding: 15px 20px;
            font-size: 1.3rem;
            border: 3px solid #667eea;
            border-radius: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 3px;
            max-width: 300px;
            font-weight: bold;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            font-weight: bold;
        }

        .btn:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .chat-container {
            background: #f7fafc;
            border-radius: 15px;
            padding: 0;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            height: 400px;
            display: flex;
            flex-direction: column;
            margin: 20px 0;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            background: #f1f5f9;
            border-left: 4px solid #667eea;
        }

        .message.own {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border-left: none;
            border-right: 4px solid #4c51bf;
        }

        .message.system {
            background: #fef5e7;
            border-left-color: #f6ad55;
            text-align: center;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
        }

        .message .sender {
            font-weight: bold;
            font-size: 0.85rem;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .message .timestamp {
            font-size: 0.75rem;
            opacity: 0.6;
            margin-top: 5px;
        }

        .chat-input {
            padding: 20px;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 999;
        }

        .connection-status.disconnected {
            background: #e53e3e;
        }

        .online-members {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .member-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .member-tag {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .member-tag.online::before {
            content: "üü¢";
        }

        .member-tag.offline::before {
            content: "‚ö™";
        }

        .app-area {
            display: none;
        }

        .app-area.active {
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #48bb78;
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            z-index: 1000;
            animation: slideDown 0.5s ease-out;
            display: none;
        }

        .notification.show {
            display: block;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .config-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- √âcran de connexion -->
        <div id="connectionSetup" class="connection-setup">
            <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famille Connect Pro</h1>
            <h2>Version Supabase - Temps R√©el</h2>
            
            <p style="margin: 20px 0; font-size: 1.1rem;">
                Pour commencer, rejoignez ou cr√©ez votre espace familial :
            </p>

            <div class="family-code-input">
                <div>
                    <h3>üîë Rejoindre une famille existante</h3>
                    <input type="text" id="familyCodeInput" placeholder="CODE FAMILLE" maxlength="8">
                    <button class="btn" onclick="joinFamily()">Rejoindre</button>
                </div>
                
                <div style="margin: 20px 0;">
                    <strong>OU</strong>
                </div>
                
                <div>
                    <h3>üè† Cr√©er une nouvelle famille</h3>
                    <input type="text" id="newFamilyName" placeholder="Nom de votre famille">
                    <button class="btn secondary" onclick="createFamily()">Cr√©er</button>
                </div>
            </div>

            <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-top: 30px;">
                <h4>üí° Comment √ßa marche :</h4>
                <ol style="text-align: left; margin: 15px 0;">
                    <li><strong>Cr√©ez votre famille</strong> ‚Üí Vous recevez un code (ex: FAM8X2K9)</li>
                    <li><strong>Partagez ce code</strong> avec votre famille</li>
                    <li><strong>Ils rejoignent</strong> avec le m√™me code</li>
                    <li><strong>Vous communiquez</strong> en temps r√©el via Supabase !</li>
                </ol>
            </div>
        </div>

        <!-- Application principale -->
        <div id="appArea" class="app-area">
            <div style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 35px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap;">
                    <h2 id="familyTitle">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Chat Familial</h2>
                    <div>
                        <button class="btn secondary" onclick="copyFamilyCode()">üìã Partager code</button>
                        <button class="btn" onclick="showFamilyCode()">üîë Voir code</button>
                        <button class="btn" onclick="disconnect()" style="background: #e53e3e;">üö™ Quitter</button>
                    </div>
                </div>

                <!-- Membres en ligne -->
                <div class="online-members">
                    <h4>üë• Membres connect√©s :</h4>
                    <div class="member-list" id="membersList">
                        <!-- Les membres seront affich√©s ici -->
                    </div>
                </div>

                <!-- Chat en temps r√©el -->
                <div class="chat-container">
                    <div class="chat-header">
                        <span>üí¨ Messages en temps r√©el</span>
                        <span id="connectionIndicator">üü¢ Connect√©</span>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages en temps r√©el -->
                    </div>
                    
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Tapez votre message..." onkeypress="handleKeyPress(event)">
                        <button class="btn" onclick="sendMessage()">üì§</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Status de connexion -->
    <div id="connectionStatus" class="connection-status">
        üî¥ Non connect√©
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Variables globales
        let supabase = null;
        let currentFamily = null;
        let currentUser = null;
        let messagesSubscription = null;
        let membersSubscription = null;

        // Configuration Supabase automatique
        const SUPABASE_URL = 'https://idchzyesasphuxozzqdz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkY2h6eWVzYXNwaHV4eG96cWR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NjEzOTQsImV4cCI6MjA2NDAzNzM5NH0.bESGwp0R-OpEndUA2QuO1gUdvSxt4JTlP-q1Yi2fh20';

        // Initialiser Supabase automatiquement
        function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Tester la connexion
                testSupabaseConnection();
                
            } catch (error) {
                console.error('Erreur Supabase:', error);
                showNotification('‚ùå Erreur de connexion Supabase', 'error');
            }
        }

        // Tester la connexion Supabase
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabase.from('families').select('id').limit(1);
                
                if (error) {
                    console.error('Erreur test:', error);
                    showNotification('‚ùå Erreur de connexion √† la base de donn√©es', 'error');
                    return;
                }

                // Connexion r√©ussie
                showNotification('‚úÖ Application pr√™te √† l\'utilisation !', 'success');
                updateConnectionStatus(true);

                // V√©rifier si l'utilisateur a d√©j√† une famille
                checkExistingSession();

            } catch (error) {
                console.error('Erreur de test:', error);
                showNotification('‚ùå Probl√®me de connexion', 'error');
            }
        }

        // V√©rifier une session existante
        function checkExistingSession() {
            const savedFamilyCode = localStorage.getItem('familyCode');
            const savedUserName = localStorage.getItem('userName');
            
            if (savedFamilyCode && savedUserName) {
                currentFamily = savedFamilyCode;
                currentUser = savedUserName;
                
                // V√©rifier que la famille existe encore
                getFamilyData(savedFamilyCode).then(familyData => {
                    if (familyData) {
                        showApp(familyData.name, savedFamilyCode);
                        updateUserOnlineStatus(true);
                    } else {
                        // Famille n'existe plus, nettoyer
                        localStorage.removeItem('familyCode');
                        localStorage.removeItem('userName');
                    }
                });
            }
        }

        // Cr√©er une nouvelle famille
        async function createFamily() {
            if (!supabase) {
                showNotification('‚ö†Ô∏è Connexion en cours...', 'warning');
                return;
            }

            const familyName = document.getElementById('newFamilyName').value.trim();
            
            if (!familyName) {
                showNotification('‚ö†Ô∏è Entrez un nom de famille', 'warning');
                return;
            }

            const userName = prompt('Votre pr√©nom :');
            if (!userName) return;

            try {
                setLoading(true);
                
                // G√©n√©rer un code famille unique
                const familyCode = generateFamilyCode();
                
                // Cr√©er la famille dans Supabase
                const { data: familyData, error: familyError } = await supabase
                    .from('families')
                    .insert([
                        {
                            code: familyCode,
                            name: familyName,
                            creator: userName
                        }
                    ])
                    .select()
                    .single();

                if (familyError) {
                    console.error('Erreur famille:', familyError);
                    showNotification('‚ùå Erreur lors de la cr√©ation', 'error');
                    return;
                }

                // Ajouter le cr√©ateur comme membre
                await addFamilyMember(familyCode, userName);

                // Ajouter message de bienvenue
                await sendSystemMessage(familyCode, `Bienvenue dans ${familyName} ! üéâ`);

                currentFamily = familyCode;
                currentUser = userName;
                
                localStorage.setItem('familyCode', familyCode);
                localStorage.setItem('userName', userName);
                
                showNotification(`üéâ Famille "${familyName}" cr√©√©e ! Code: ${familyCode}`, 'success');
                showApp(familyName, familyCode);
                
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('‚ùå Erreur inattendue', 'error');
            } finally {
                setLoading(false);
            }
        }

        // Rejoindre une famille existante
        async function joinFamily() {
            if (!supabase) {
                showNotification('‚ö†Ô∏è Connexion en cours...', 'warning');
                return;
            }

            const familyCode = document.getElementById('familyCodeInput').value.trim().toUpperCase();
            
            if (!familyCode) {
                showNotification('‚ö†Ô∏è Entrez un code famille', 'warning');
                return;
            }

            const userName = prompt('Votre pr√©nom :');
            if (!userName) return;

            try {
                setLoading(true);

                // V√©rifier si la famille existe
                const familyData = await getFamilyData(familyCode);
                
                if (!familyData) {
                    showNotification('‚ùå Code famille invalide', 'error');
                    return;
                }

                // Ajouter le membre
                await addFamilyMember(familyCode, userName);

                // Message de bienvenue
                await sendSystemMessage(familyCode, `${userName} a rejoint la famille ! üëã`);

                currentFamily = familyCode;
                currentUser = userName;
                
                localStorage.setItem('familyCode', familyCode);
                localStorage.setItem('userName', userName);
                
                showNotification(`üéâ Vous avez rejoint ${familyData.name} !`, 'success');
                showApp(familyData.name, familyCode);
                
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('‚ùå Erreur lors de la connexion', 'error');
            } finally {
                setLoading(false);
            }
        }

        // Ajouter un membre √† la famille
        async function addFamilyMember(familyCode, userName) {
            const { error } = await supabase
                .from('family_members')
                .upsert([
                    {
                        family_code: familyCode,
                        name: userName,
                        is_online: true,
                        last_seen: new Date().toISOString()
                    }
                ]);

            if (error && error.code !== '23505') { // Ignorer erreur de doublons
                throw error;
            }
        }

        // Obtenir les donn√©es d'une famille
        async function getFamilyData(familyCode) {
            const { data, error } = await supabase
                .from('families')
                .select('*')
                .eq('code', familyCode)
                .single();

            if (error) {
                console.error('Erreur getFamilyData:', error);
                return null;
            }

            return data;
        }

        // Envoyer un message syst√®me
        async function sendSystemMessage(familyCode, text) {
            const { error } = await supabase
                .from('messages')
                .insert([
                    {
                        family_code: familyCode,
                        sender: 'Syst√®me',
                        text: text,
                        message_type: 'system'
                    }
                ]);

            if (error) {
                console.error('Erreur message syst√®me:', error);
            }
        }

        // Afficher l'application
        function showApp(familyName, familyCode) {
            document.getElementById('connectionSetup').style.display = 'none';
            document.getElementById('appArea').classList.add('active');
            document.getElementById('familyTitle').textContent = `üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${familyName}`;
            
            // D√©marrer l'√©coute temps r√©el
            startRealtimeListeners();
            updateUserOnlineStatus(true);
        }

        // D√©marrer l'√©coute temps r√©el
        function startRealtimeListeners() {
            // √âcouter les nouveaux messages
            messagesSubscription = supabase
                .channel('messages')
                .on('postgres_changes', 
                    { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'messages',
                        filter: `family_code=eq.${currentFamily}`
                    }, 
                    handleNewMessage
                )
                .subscribe();

            // √âcouter les changements de membres
            membersSubscription = supabase
                .channel('members')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'family_members',
                        filter: `family_code=eq.${currentFamily}`
                    }, 
                    loadMembers
                )
                .subscribe();

            // Charger les donn√©es initiales
            loadMessages();
            loadMembers();

            // Mettre √† jour le statut en ligne p√©riodiquement
            setInterval(() => updateUserOnlineStatus(true), 30000);
        }

        // G√©rer un nouveau message
        function handleNewMessage(payload) {
            const message = payload.new;
            displayMessage(message);
        }

        // Charger tous les messages
        async function loadMessages() {
            const { data: messages, error } = await supabase
                .from('messages')
                .select('*')
                .eq('family_code', currentFamily)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Erreur chargement messages:', error);
                return;
            }

            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';

            messages.forEach(message => {
                displayMessage(message);
            });
        }

        // Afficher un message
        function displayMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            let className = 'message';
            if (message.sender === currentUser) className += ' own';
            if (message.message_type === 'system') className += ' system';
            
            messageDiv.className = className;
            
            const time = new Date(message.created_at).toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.innerHTML = `
                <div class="sender">${message.sender}</div>
                <div>${message.text}</div>
                <div class="timestamp">${time}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Charger les membres
        async function loadMembers() {
            const { data: members, error } = await supabase
                .from('family_members')
                .select('*')
                .eq('family_code', currentFamily);

            if (error) {
                console.error('Erreur chargement membres:', error);
                return;
            }

            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';

            members.forEach(member => {
                const memberTag = document.createElement('div');
                
                // Consid√©rer en ligne si vu dans les 2 derni√®res minutes
                const lastSeen = new Date(member.last_seen);
                const now = new Date();
                const isOnline = (now - lastSeen) < 2 * 60 * 1000; // 2 minutes
                
                memberTag.className = `member-tag ${isOnline ? 'online' : 'offline'}`;
                memberTag.textContent = member.name;
                membersList.appendChild(memberTag);
            });
        }

        // Mettre √† jour le statut en ligne
        async function updateUserOnlineStatus(isOnline) {
            if (!currentFamily || !currentUser) return;

            const { error } = await supabase
                .from('family_members')
                .update({
                    is_online: isOnline,
                    last_seen: new Date().toISOString()
                })
                .eq('family_code', currentFamily)
                .eq('name', currentUser);

            if (error) {
                console.error('Erreur statut:', error);
            }
        }

        // Envoyer un message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;

            try {
                const { error } = await supabase
                    .from('messages')
                    .insert([
                        {
                            family_code: currentFamily,
                            sender: currentUser,
                            text: text,
                            message_type: 'user'
                        }
                    ]);

                if (error) {
                    console.error('Erreur envoi message:', error);
                    showNotification('‚ùå Erreur envoi message', 'error');
                    return;
                }

                input.value = '';
                updateUserOnlineStatus(true); // Mettre √† jour le statut
                
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('‚ùå Erreur inattendue', 'error');
            }
        }

        // G√©rer la touche Entr√©e
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Se d√©connecter
        function disconnect() {
            if (confirm('Voulez-vous vraiment quitter la famille ?')) {
                updateUserOnlineStatus(false);
                
                // Nettoyer les subscriptions
                if (messagesSubscription) messagesSubscription.unsubscribe();
                if (membersSubscription) membersSubscription.unsubscribe();
                
                // Nettoyer le stockage local
                localStorage.removeItem('familyCode');
                localStorage.removeItem('userName');
                
                // R√©initialiser l'√©tat
                currentFamily = null;
                currentUser = null;
                
                // Retour √† l'√©cran de connexion
                document.getElementById('appArea').classList.remove('active');
                document.getElementById('connectionSetup').style.display = 'block';
                
                showNotification('üëã Vous avez quitt√© la famille', 'info');
            }
        }

        // Fonctions utilitaires
        function generateFamilyCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'FAM';
            for (let i = 0; i < 5; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showFamilyCode() {
            alert(`üîë Code de votre famille: ${currentFamily}\n\nPartagez ce code avec votre famille pour qu'ils puissent vous rejoindre !`);
        }

        function copyFamilyCode() {
            navigator.clipboard.writeText(currentFamily).then(() => {
                showNotification('üìã Code copi√© !', 'success');
            });
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const indicator = document.getElementById('connectionIndicator');
            
            if (connected) {
                status.textContent = 'üü¢ Connect√©';
                status.className = 'connection-status';
                if (indicator) indicator.textContent = 'üü¢ Connect√©';
            } else {
                status.textContent = 'üî¥ D√©connect√©';
                status.className = 'connection-status disconnected';
                if (indicator) indicator.textContent = 'üî¥ D√©connect√©';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const colors = {
                success: '#48bb78',
                error: '#e53e3e',
                warning: '#ed8936',
                info: '#4299e1'
            };
            
            notification.style.backgroundColor = colors[type] || colors.info;
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function setLoading(loading) {
            const elements = document.querySelectorAll('.btn');
            elements.forEach(btn => {
                btn.disabled = loading;
                if (loading) {
                    btn.classList.add('loading');
                } else {
                    btn.classList.remove('loading');
                }
            });
        }

        // Initialisation automatique
        window.addEventListener('DOMContentLoaded', function() {
            // Se connecter automatiquement √† Supabase
            initializeSupabase();
        });

        // Gestion de la fermeture de la page
        window.addEventListener('beforeunload', () => {
            updateUserOnlineStatus(false);
        });

        // Gestion de la visibilit√© de la page
        document.addEventListener('visibilitychange', () => {
            if (currentFamily && currentUser) {
                updateUserOnlineStatus(!document.hidden);
            }
        });
    </script>
</body>
</html>
