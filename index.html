<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Famille Connect Pro - Version Finale</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        /* =================
           √âCRAN DE CONNEXION
           ================= */
        .connection-setup {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(20px);
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .connection-setup h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .family-code-section {
            margin: 30px 0;
            padding: 25px;
            background: #f8fafc;
            border-radius: 20px;
            border: 2px solid #e2e8f0;
        }

        .family-code-input {
            margin: 20px 0;
        }

        .family-code-input input {
            width: 100%;
            max-width: 300px;
            padding: 15px 20px;
            font-size: 1.2rem;
            border: 3px solid #667eea;
            border-radius: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .family-code-input input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            transform: scale(1.02);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px;
            font-weight: 600;
            min-width: 120px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled::before {
            display: none;
        }

        /* =================
           APPLICATION PRINCIPALE
           ================= */
        .app-area {
            display: none;
            animation: fadeIn 0.6s ease-out;
        }

        .app-area.active {
            display: block;
        }

        .header-section {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-controls h2 {
            font-size: 1.8rem;
            color: #4a5568;
            margin: 0;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* =================
           NAVIGATION TABS
           ================= */
        .navigation-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            gap: 5px;
        }

        .nav-tab {
            flex: 1;
            min-width: 80px;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* =================
           SECTIONS DE CONTENU
           ================= */
        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            animation: fadeIn 0.5s ease-out;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h3 {
            font-size: 1.5rem;
            color: #4a5568;
            margin: 0;
        }

        /* =================
           CHAT TEMPS R√âEL
           ================= */
        .chat-container {
            background: #f7fafc;
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
            height: 450px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            animation: slideIn 0.3s ease-out;
            position: relative;
        }

        .message.own {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border-color: #667eea;
        }

        .message.system {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            text-align: center;
            max-width: 100%;
            margin: 10px auto;
            font-style: italic;
            border-color: #fbbf24;
        }

        .message .sender {
            font-weight: bold;
            font-size: 0.85rem;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .message .timestamp {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .chat-input {
            padding: 20px;
            background: #f7fafc;
            border-top: 2px solid #e2e8f0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input input:focus {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }

        /* =================
           MEMBRES DE LA FAMILLE
           ================= */
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .member-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            border: 3px solid transparent;
        }

        .member-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .member-card:hover::before {
            left: 100%;
        }

        .member-card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.5);
        }

        .member-avatar {
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            border: 3px solid rgba(255,255,255,0.5);
            overflow: hidden;
            position: relative;
        }

        .member-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .online-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 15px;
            height: 15px;
            background: #48bb78;
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }

        .online-indicator.offline {
            background: #e53e3e;
            animation: none;
        }

        /* =================
           GALERIE PHOTOS
           ================= */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .photo-item {
            aspect-ratio: 1;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }

        .photo-item:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-upload {
            border: 3px dashed #667eea;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            font-weight: bold;
        }

        /* =================
           JEUX
           ================= */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .game-card {
            color: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            border: 3px solid transparent;
        }

        .game-card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.5);
        }

        .game-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
            animation: bounce 2s infinite;
        }

        .game-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .game-description {
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .game-difficulty {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        /* =================
           ZONE DE JEU
           ================= */
        .game-area {
            display: none;
            background: #f8f9fa;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
        }

        .game-area.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        .memory-grid {
            display: grid;
            gap: 15px;
            justify-content: center;
            margin: 20px auto;
            max-width: 600px;
        }

        .memory-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            min-height: 80px;
        }

        .memory-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .memory-card.flipped {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .memory-card.matched {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            opacity: 0.7;
            cursor: default;
        }

        /* =================
           VID√âOCONF√âRENCE
           ================= */
        .video-conference {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .video-item {
            position: relative;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            aspect-ratio: 4/3;
        }

        .video-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .video-control-btn {
            background: rgba(0,0,0,0.7);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .video-control-btn:hover {
            background: rgba(0,0,0,0.9);
            transform: scale(1.1);
        }

        .video-control-btn.active {
            background: #e53e3e;
        }

        /* =================
           STATISTIQUES
           ================= */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #84fab0, #8fd3f4);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            color: white;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* =================
           MODALES
           ================= */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
            animation: modalZoom 0.3s ease-out;
        }

        /* =================
           NOTIFICATIONS
           ================= */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            z-index: 1000;
            animation: slideInRight 0.5s ease-out;
            display: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            max-width: 400px;
        }

        .notification.show {
            display: block;
        }

        .notification.error {
            background: #e53e3e;
        }

        .notification.warning {
            background: #ed8936;
        }

        .notification.info {
            background: #4299e1;
        }

        /* =================
           STATUS DE CONNEXION
           ================= */
        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #48bb78;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 999;
            transition: all 0.3s ease;
        }

        .connection-status.disconnected {
            background: #e53e3e;
        }

        /* =================
           FORM ELEMENTS
           ================= */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            outline: none;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }

        /* =================
           ANIMATIONS
           ================= */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes modalZoom {
            from { transform: scale(0.7); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* =================
           RESPONSIVE DESIGN
           ================= */
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .connection-setup {
                margin: 10px;
                padding: 20px;
            }
            
            .connection-setup h1 {
                font-size: 2rem;
            }
            
            .family-code-input input {
                font-size: 1rem;
                max-width: 250px;
            }
            
            .header-controls {
                flex-direction: column;
                text-align: center;
            }
            
            .header-controls h2 {
                font-size: 1.5rem;
            }
            
            .navigation-tabs {
                padding: 5px;
            }
            
            .nav-tab {
                padding: 10px 12px;
                font-size: 0.8rem;
            }
            
            .chat-container {
                height: 350px;
            }
            
            .members-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }
            
            .games-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .video-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
            
            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* =================
           UTILITY CLASSES
           ================= */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .text-center {
            text-align: center;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ========================
             √âCRAN DE CONNEXION
             ======================== -->
        <div id="connectionSetup" class="connection-setup">
            <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famille Connect Pro</h1>
            <h2 style="color: #718096; margin-bottom: 10px;">L'application familiale compl√®te</h2>
            <p style="color: #a0aec0; margin-bottom: 30px;">
                Chat temps r√©el ‚Ä¢ Photos ‚Ä¢ Jeux ‚Ä¢ Vid√©oconf√©rences
            </p>

            <div class="family-code-section">
                <h3 style="color: #4a5568; margin-bottom: 20px;">üîë Rejoindre une famille</h3>
                <div class="family-code-input">
                    <input type="text" id="familyCodeInput" placeholder="CODE FAMILLE" maxlength="8">
                    <br>
                    <button class="btn" onclick="joinFamily()">Rejoindre</button>
                </div>
            </div>
            
            <div style="margin: 20px 0; font-size: 1.2rem; font-weight: bold; color: #888;">
                OU
            </div>
            
            <div class="family-code-section">
                <h3 style="color: #4a5568; margin-bottom: 20px;">üè† Cr√©er une nouvelle famille</h3>
                <div class="family-code-input">
                    <input type="text" id="newFamilyName" placeholder="Nom de votre famille">
                    <br>
                    <button class="btn secondary" onclick="createFamily()">Cr√©er ma famille</button>
                </div>
            </div>

            <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); padding: 20px; border-radius: 15px; margin-top: 30px; border: 1px solid #bfdbfe;">
                <h4 style="color: #1e40af; margin-bottom: 15px;">üí° Comment √ßa marche :</h4>
                <div style="text-align: left; font-size: 0.95rem; color: #1e3a8a; line-height: 1.6;">
                    <p><strong>1.</strong> Cr√©ez votre famille ‚Üí Vous recevez un code unique</p>
                    <p><strong>2.</strong> Partagez ce code avec votre famille</p>
                    <p><strong>3.</strong> Ils rejoignent avec le m√™me code</p>
                    <p><strong>4.</strong> Profitez du chat, photos, jeux et vid√©os !</p>
                </div>
            </div>
        </div>

        <!-- ========================
             APPLICATION PRINCIPALE
             ======================== -->
        <div id="appArea" class="app-area">
            <!-- Header -->
            <div class="header-section">
                <div class="header-controls">
                    <h2 id="familyTitle">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ma Famille</h2>
                    <div class="header-buttons">
                        <button class="btn secondary" onclick="copyFamilyCode()">üìã Partager code</button>
                        <button class="btn" onclick="showFamilyCode()">üîë Code famille</button>
                        <button class="btn danger" onclick="disconnect()">üö™ Quitter</button>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="navigation-tabs">
                <button class="nav-tab active" onclick="showSection('chat')">üí¨ Chat</button>
                <button class="nav-tab" onclick="showSection('family')">üë• Famille</button>
                <button class="nav-tab" onclick="showSection('photos')">üì∏ Photos</button>
                <button class="nav-tab" onclick="showSection('games')">üéÆ Jeux</button>
                <button class="nav-tab" onclick="showSection('video')">üìπ Vid√©o</button>
                <button class="nav-tab" onclick="showSection('settings')">‚öôÔ∏è R√©glages</button>
            </div>

            <!-- ========================
                 SECTION CHAT
                 ======================== -->
            <div id="chatSection" class="content-section active">
                <div class="section-header">
                    <h3>üí¨ Chat Familial en Temps R√©el</h3>
                    <div>
                        <button class="btn secondary" onclick="clearChat()">üóëÔ∏è Effacer</button>
                        <button class="btn" onclick="addQuickMessage()">‚ö° Message rapide</button>
                    </div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-header">
                        <span>üí¨ Messages instantan√©s</span>
                        <span id="connectionIndicator">üü¢ Connect√©</span>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <div class="message system">
                            <div>üéâ Bienvenue ! Commencez √† chatter avec votre famille...</div>
                        </div>
                    </div>
                    
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Tapez votre message..." onkeypress="handleKeyPress(event)">
                        <button class="btn secondary" onclick="addPhotoToChat()">üì∑</button>
                        <button class="btn" onclick="sendMessage()">üì§</button>
                    </div>
                </div>
            </div>

            <!-- ========================
                 SECTION FAMILLE
                 ======================== -->
            <div id="familySection" class="content-section">
                <div class="section-header">
                    <h3>üë• Ma Famille</h3>
                    <button class="btn" onclick="addFamilyMember()">‚ûï Ajouter membre</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalMembers">0</div>
                        <div class="stat-label">Membres</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="onlineMembers">0</div>
                        <div class="stat-label">En ligne</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalMessages">0</div>
                        <div class="stat-label">Messages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalPhotos">0</div>
                        <div class="stat-label">Photos</div>
                    </div>
                </div>
                
                <div class="members-grid" id="membersGrid">
                    <!-- Les membres seront charg√©s ici -->
                </div>
            </div>

            <!-- ========================
                 SECTION PHOTOS
                 ======================== -->
            <div id="photosSection" class="content-section">
                <div class="section-header">
                    <h3>üì∏ Galerie Familiale</h3>
                    <button class="btn" onclick="uploadPhotos()">üì§ Ajouter photos</button>
                </div>
                
                <div class="photo-grid" id="photoGrid">
                    <div class="photo-item photo-upload" onclick="uploadPhotos()">
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">üì§</div>
                            <div style="font-weight: bold;">Ajouter photos</div>
                        </div>
                    </div>
                </div>
                
                <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(event)">
            </div>

            <!-- ========================
                 SECTION JEUX
                 ======================== -->
            <div id="gamesSection" class="content-section">
                <div class="section-header">
                    <h3>üéÆ Centre de Jeux</h3>
                    <div>
                        <button class="btn secondary" onclick="refreshAllGames()">üîÑ Renouveler</button>
                        <button class="btn" onclick="randomGame()">üé≤ Jeu surprise</button>
                    </div>
                </div>
                
                <div class="games-grid">
                    <div class="game-card" onclick="startMemoryGame()" style="background: linear-gradient(135deg, #ff9a9e, #fecfef);">
                        <div class="game-icon">üß†</div>
                        <div class="game-title">Jeu de M√©moire</div>
                        <div class="game-description">Trouvez les paires</div>
                        <div class="game-difficulty">Niveau <span id="memoryLevel">1</span></div>
                    </div>
                    
                    <div class="game-card" onclick="startQuizGame()" style="background: linear-gradient(135deg, #a8edea, #fed6e3);">
                        <div class="game-icon">‚ùì</div>
                        <div class="game-title">Quiz Familial</div>
                        <div class="game-description">Questions amusantes</div>
                        <div class="game-difficulty">Facile</div>
                    </div>
                    
                    <div class="game-card" onclick="startWordGame()" style="background: linear-gradient(135deg, #ffecd2, #fcb69f);">
                        <div class="game-icon">üìù</div>
                        <div class="game-title">Mots M√©lang√©s</div>
                        <div class="game-description">Devinez les mots</div>
                        <div class="game-difficulty">Moyen</div>
                    </div>
                    
                    <div class="game-card" onclick="startReactionGame()" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <div class="game-icon">‚ö°</div>
                        <div class="game-title">Test de R√©flexes</div>
                        <div class="game-description">Rapidit√© et pr√©cision</div>
                        <div class="game-difficulty">Intensif</div>
                    </div>
                </div>

                <!-- Zone de jeu -->
                <div id="gameArea" class="game-area">
                    <div id="gameContent"></div>
                    <div class="text-center mt-20">
                        <button class="btn danger" onclick="closeGame()">üö™ Quitter le jeu</button>
                    </div>
                </div>
            </div>

            <!-- ========================
                 SECTION VID√âO
                 ======================== -->
            <div id="videoSection" class="content-section">
                <div class="section-header">
                    <h3>üìπ Appels Vid√©o Familiaux</h3>
                    <div>
                        <button class="btn" onclick="startVideoCall()" id="startCallBtn">üìû D√©marrer appel</button>
                        <button class="btn danger" onclick="endVideoCall()" id="endCallBtn" style="display: none;">üìû Terminer</button>
                    </div>
                </div>
                
                <div class="video-conference">
                    <div class="video-grid" id="videoGrid">
                        <div class="video-item" id="localVideoContainer">
                            <video id="localVideo" autoplay muted></video>
                            <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 10px;">
                                üë§ Vous
                            </div>
                            <div class="video-controls">
                                <button class="video-control-btn" onclick="toggleMicrophone()" id="micBtn">üé§</button>
                                <button class="video-control-btn" onclick="toggleCamera()" id="cameraBtn">üìπ</button>
                                <button class="video-control-btn" onclick="shareScreen()" id="screenBtn">üñ•Ô∏è</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center" style="color: white; margin-top: 20px;">
                        <p id="callStatus">Pr√™t pour un appel vid√©o</p>
                        <p id="participantsList" style="font-size: 0.9rem; opacity: 0.8;"></p>
                    </div>
                </div>
            </div>

            <!-- ========================
                 SECTION R√âGLAGES
                 ======================== -->
            <div id="settingsSection" class="content-section">
                <div class="section-header">
                    <h3>‚öôÔ∏è Param√®tres</h3>
                    <div>
                        <button class="btn" onclick="exportData()">üíæ Sauvegarder</button>
                        <button class="btn secondary" onclick="importData()">üì§ Charger</button>
                    </div>
                </div>
                
                <div style="background: #f0f9ff; padding: 20px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                    <p style="margin: 0; font-weight: 600; color: #1e40af;">
                        üîó Connect√© √† Supabase - Synchronisation temps r√©el active
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="settingsFamilyName">Nom de famille :</label>
                    <input type="text" id="settingsFamilyName" placeholder="Nom de famille">
                </div>
                
                <div class="form-group">
                    <label for="settingsUserName">Votre pr√©nom :</label>
                    <input type="text" id="settingsUserName" placeholder="Votre pr√©nom">
                </div>
                
                <div class="text-center mt-20">
                    <button class="btn" onclick="saveSettings()">üíæ Sauvegarder</button>
                    <button class="btn secondary" onclick="resetApp()">üîÑ R√©initialiser</button>
                </div>
                
                <!-- Statistiques de session -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-top: 30px;">
                    <h4 style="color: #4a5568; margin-bottom: 15px;">üìä Statistiques de session</h4>
                    <div class="stats-grid">
                        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;" id="sessionDuration">00:00</div>
                            <div style="font-size: 0.9rem; color: #666;">Dur√©e</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #48bb78;" id="messagesSent">0</div>
                            <div style="font-size: 0.9rem; color: #666;">Messages envoy√©s</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #ed8936;" id="gamesPlayed">0</div>
                            <div style="font-size: 0.9rem; color: #666;">Jeux jou√©s</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #9f7aea;" id="photosAdded">0</div>
                            <div style="font-size: 0.9rem; color: #666;">Photos ajout√©es</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================
         MODALES
         ======================== -->
    <!-- Modale Ajout Membre -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">üë• Ajouter un membre</h3>
            
            <div class="form-group">
                <label for="memberName">Nom :</label>
                <input type="text" id="memberName" placeholder="Nom du membre">
            </div>
            
            <div class="form-group">
                <label for="memberRole">R√¥le :</label>
                <select id="memberRole">
                    <option value="parent">Parent</option>
                    <option value="enfant">Enfant</option>
                    <option value="grand-parent">Grand-parent</option>
                    <option value="autre">Autre</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="memberEmoji">Emoji :</label>
                <input type="text" id="memberEmoji" placeholder="üòä" maxlength="2">
            </div>
            
            <div class="text-center mt-20">
                <button class="btn" onclick="saveMember()">üíæ Ajouter</button>
                <button class="btn secondary" onclick="closeMemberModal()">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <!-- Status de connexion -->
    <div id="connectionStatus" class="connection-status">
        üü¢ Connect√©
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // ========================
        // VARIABLES GLOBALES
        // ========================
        let supabase = null;
        let currentFamily = null;
        let currentUser = null;
        let messagesSubscription = null;
        let membersSubscription = null;
        let sessionStartTime = null;
        let sessionStats = {
            messagesSent: 0,
            gamesPlayed: 0,
            photosAdded: 0
        };

        // Configuration Supabase
        const SUPABASE_URL = 'https://idchzyesasphuxxozqdz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkY2h6eWVzYXNwaHV4eG96cWR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NjEzOTQsImV4cCI6MjA2NDAzNzM5NH0.bESGwp0R-OpEndUA2QuO1gUdvSxt4JTlP-q1Yi2fh20';

        // √âtat de l'application
        let appState = {
            members: [],
            photos: [],
            currentGame: null,
            videoCall: {
                active: false,
                localStream: null,
                participants: []
            }
        };

        // ========================
        // INITIALISATION
        // ========================
        function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase initialis√©');
                return true;
            } catch (error) {
                console.error('‚ùå Erreur Supabase:', error);
                showNotification('‚ùå Erreur de connexion', 'error');
                return false;
            }
        }

        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabase.from('families').select('id').limit(1);
                
                if (error) {
                    console.error('Erreur connexion:', error);
                    updateConnectionStatus(false);
                    return false;
                }

                console.log('‚úÖ Connexion Supabase r√©ussie');
                updateConnectionStatus(true);
                return true;

            } catch (error) {
                console.error('Erreur test connexion:', error);
                updateConnectionStatus(false);
                return false;
            }
        }

        async function checkExistingSession() {
            const savedFamilyCode = localStorage.getItem('familyCode');
            const savedUserName = localStorage.getItem('userName');
            
            if (savedFamilyCode && savedUserName) {
                currentFamily = savedFamilyCode;
                currentUser = savedUserName;
                
                const familyData = await getFamilyData(savedFamilyCode);
                if (familyData) {
                    showApp(familyData.name, savedFamilyCode);
                    updateUserOnlineStatus(true);
                    showNotification(`üëã Reconnect√© √† ${familyData.name}`, 'info');
                } else {
                    localStorage.removeItem('familyCode');
                    localStorage.removeItem('userName');
                }
            }
        }

        // ========================
        // GESTION DES FAMILLES
        // ========================
        async function createFamily() {
            if (!supabase) {
                showNotification('‚ö†Ô∏è Connexion en cours...', 'warning');
                return;
            }

            const familyName = document.getElementById('newFamilyName').value.trim();
            
            if (!familyName) {
                showNotification('‚ö†Ô∏è Entrez un nom de famille', 'warning');
                return;
            }

            const userName = prompt('Votre pr√©nom :');
            if (!userName) return;

            try {
                setLoading(true);
                
                const familyCode = generateFamilyCode();
                
                const { data: familyData, error: familyError } = await supabase
                    .from('families')
                    .insert([
                        {
                            code: familyCode,
                            name: familyName,
                            creator: userName
                        }
                    ])
                    .select()
                    .single();

                if (familyError) {
                    console.error('Erreur famille:', familyError);
                    showNotification('‚ùå Erreur lors de la cr√©ation', 'error');
                    return;
                }

                await addFamilyMemberToDb(familyCode, userName);
                await sendSystemMessage(familyCode, `Bienvenue dans ${familyName} ! üéâ`);

                currentFamily = familyCode;
                currentUser = userName;
                
                localStorage.setItem('familyCode', familyCode);
                localStorage.setItem('userName', userName);
                
                showNotification(`üéâ Famille "${familyName}" cr√©√©e !`, 'success');
                showApp(familyName, familyCode);
                
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('‚ùå Erreur inattendue', 'error');
            } finally {
                setLoading(false);
            }
        }

        async function joinFamily() {
            if (!supabase) {
                showNotification('‚ö†Ô∏è Connexion en cours...', 'warning');
                return;
            }

            const familyCode = document.getElementById('familyCodeInput').value.trim().toUpperCase();
            
            if (!familyCode) {
                showNotification('‚ö†Ô∏è Entrez un code famille', 'warning');
                return;
            }

            const userName = prompt('Votre pr√©nom :');
            if (!userName) return;

            try {
                setLoading(true);

                const familyData = await getFamilyData(familyCode);
                
                if (!familyData) {
                    showNotification('‚ùå Code famille invalide', 'error');
                    return;
                }

                await addFamilyMemberToDb(familyCode, userName);
                await sendSystemMessage(familyCode, `${userName} a rejoint la famille ! üëã`);

                currentFamily = familyCode;
                currentUser = userName;
                
                localStorage.setItem('familyCode', familyCode);
                localStorage.setItem('userName', userName);
                
                showNotification(`üéâ Vous avez rejoint ${familyData.name} !`, 'success');
                showApp(familyData.name, familyCode);
                
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('‚ùå Erreur lors de la connexion', 'error');
            } finally {
                setLoading(false);
            }
        }

        async function addFamilyMemberToDb(familyCode, userName) {
            const { error } = await supabase
                .from('family_members')
                .upsert([
                    {
                        family_code: familyCode,
                        name: userName,
                        is_online: true,
                        last_seen: new Date().toISOString()
                    }
                ]);

            if (error && error.code !== '23505') {
                throw error;
            }
        }

        async function getFamilyData(familyCode) {
            const { data, error } = await supabase
                .from('families')
                .select('*')
                .eq('code', familyCode)
                .single();

            if (error) {
                console.error('Erreur getFamilyData:', error);
                return null;
            }

            return data;
        }

        async function sendSystemMessage(familyCode, text) {
            const { error } = await supabase
                .from('messages')
                .insert([
                    {
                        family_code: familyCode,
                        sender: 'Syst√®me',
                        text: text,
                        message_type: 'system'
                    }
                ]);

            if (error) {
                console.error('Erreur message syst√®me:', error);
            }
        }

        // ========================
        // INTERFACE UTILISATEUR
        // ========================
        function showApp(familyName, familyCode) {
            document.getElementById('connectionSetup').style.display = 'none';
            document.getElementById('appArea').classList.add('active');
            document.getElementById('familyTitle').textContent = `üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${familyName}`;
            
            sessionStartTime = Date.now();
            startRealtimeListeners();
            updateUserOnlineStatus(true);
            updateSessionTimer();
        }

        function showSection(sectionName) {
            // Cacher toutes les sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // D√©sactiver tous les onglets
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Afficher la section demand√©e
            document.getElementById(sectionName + 'Section').classList.add('active');
            
            // Activer l'onglet correspondant
            event.target.classList.add('active');
            
            // Actions sp√©cifiques selon la section
            switch(sectionName) {
                case 'family':
                    loadMembers();
                    break;
                case 'photos':
                    renderPhotoGallery();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // ========================
        // CHAT TEMPS R√âEL
        // ========================
        function startRealtimeListeners() {
            messagesSubscription = supabase
                .channel('messages_' + currentFamily)
                .on('postgres_changes', 
                    { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'messages',
                        filter: `family_code=eq.${currentFamily}`
                    }, 
                    handleNewMessage
                )
                .subscribe();

            membersSubscription = supabase
                .channel('members_' + currentFamily)
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'family_members',
                        filter: `family_code=eq.${currentFamily}`
                    }, 
                    loadMembers
                )
                .subscribe();

            loadMessages();
            loadMembers();

            setInterval(() => updateUserOnlineStatus(true), 30000);
        }

        function handleNewMessage(payload) {
            const message = payload.new;
            displayMessage(message);
            updateStats();
        }

        async function loadMessages() {
            const { data: messages, error } = await supabase
                .from('messages')
                .select('*')
                .eq('family_code', currentFamily)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Erreur chargement messages:', error);
                return;
            }

            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';

            messages.forEach(message => {
                displayMessage(message);
            });

            updateStats();
        }

        function displayMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            let className = 'message';
            if (message.sender === currentUser) className += ' own';
            if (message.message_type === 'system') className += ' system';
            
            messageDiv.className = className;
            
            const time = new Date(message.created_at).toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.innerHTML = `
                <div class="sender">${message.sender}</div>
                <div>${message.text}</div>
                <div class="timestamp">${time}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;

            try {
                const { error } = await supabase
                    .from('messages')
                    .insert([
                        {
                            family_code: currentFamily,
                            sender: currentUser,
                            text: text,
                            message_type: 'user'
                        }
                    ]);

                if (error) {
                    console.error('Erreur envoi message:', error);
                    showNotification('‚ùå Erreur envoi message', 'error');
                    return;
                }

                input.value = '';
                sessionStats.messagesSent++;
                updateUserOnlineStatus(true);
                
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('‚ùå Erreur inattendue', 'error');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function clearChat() {
            if (confirm('Effacer tous les messages ?')) {
                // Impl√©mentation simple - en r√©alit√©, il faudrait supprimer de Supabase
                document.getElementById('chatMessages').innerHTML = `
                    <div class="message system">
                        <div>üí¨ Messages effac√©s</div>
                    </div>
                `;
                showNotification('üóëÔ∏è Messages effac√©s', 'info');
            }
        }

        function addQuickMessage() {
            const quickMessages = [
                "Salut tout le monde ! üëã",
                "Comment √ßa va ? üòä", 
                "Qui veut jouer ? üéÆ",
                "Bonne journ√©e ! ‚òÄÔ∏è",
                "Je vous aime ! ‚ù§Ô∏è",
                "√Ä ce soir ! üåô"
            ];
            
            const randomMessage = quickMessages[Math.floor(Math.random() * quickMessages.length)];
            document.getElementById('messageInput').value = randomMessage;
            sendMessage();
        }

        function addPhotoToChat() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    // Simulation d'ajout de photo au chat
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('messageInput').value = `üì∑ Photo partag√©e: ${file.name}`;
                        sendMessage();
                        sessionStats.photosAdded++;
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // ========================
        // GESTION DES MEMBRES
        // ========================
        async function loadMembers() {
            const { data: members, error } = await supabase
                .from('family_members')
                .select('*')
                .eq('family_code', currentFamily);

            if (error) {
                console.error('Erreur chargement membres:', error);
                return;
            }

            appState.members = members;
            renderMembersGrid();
            updateStats();
        }

        function renderMembersGrid() {
            const container = document.getElementById('membersGrid');
            container.innerHTML = '';

            appState.members.forEach(member => {
                const memberCard = document.createElement('div');
                memberCard.className = 'member-card';
                
                const lastSeen = new Date(member.last_seen);
                const now = new Date();
                const isOnline = (now - lastSeen) < 2 * 60 * 1000; // 2 minutes
                
                memberCard.innerHTML = `
                    <div class="member-avatar">
                        ${member.emoji || 'üë§'}
                        <div class="online-indicator ${isOnline ? '' : 'offline'}"></div>
                    </div>
                    <h4>${member.name}</h4>
                    <p>${member.role || 'Membre'}</p>
                    <p>${isOnline ? 'üü¢ En ligne' : '‚ö™ Hors ligne'}</p>
                `;
                
                container.appendChild(memberCard);
            });
        }

        function addFamilyMember() {
            document.getElementById('memberModal').classList.add('show');
        }

        function closeMemberModal() {
            document.getElementById('memberModal').classList.remove('show');
        }

        async function saveMember() {
            const name = document.getElementById('memberName').value.trim();
            const role = document.getElementById('memberRole').value;
            const emoji = document.getElementById('memberEmoji').value || 'üòä';
            
            if (!name) {
                showNotification('‚ö†Ô∏è Entrez un nom', 'warning');
                return;
            }

            try {
                await addFamilyMemberToDb(currentFamily, name);
                
                // Mettre √† jour l'√©tat local temporairement
                appState.members.push({
                    name: name,
                    role: role,
                    emoji: emoji,
                    is_online: false,
                    last_seen: new Date().toISOString()
                });
                
                renderMembersGrid();
                closeMemberModal();
                showNotification(`‚úÖ ${name} ajout√© √† la famille !`, 'success');
                
                // Effacer le formulaire
                document.getElementById('memberName').value = '';
                document.getElementById('memberRole').value = 'parent';
                document.getElementById('memberEmoji').value = '';
                
            } catch (error) {
                console.error('Erreur ajout membre:', error);
                showNotification('‚ùå Erreur lors de l\'ajout', 'error');
            }
        }

        async function updateUserOnlineStatus(isOnline) {
            if (!currentFamily || !currentUser) return;

            const { error } = await supabase
                .from('family_members')
                .update({
                    is_online: isOnline,
                    last_seen: new Date().toISOString()
                })
                .eq('family_code', currentFamily)
                .eq('name', currentUser);

            if (error) {
                console.error('Erreur statut:', error);
            }
        }

        // ========================
        // GALERIE PHOTOS
        // ========================
        function uploadPhotos() {
            document.getElementById('photoInput').click();
        }

        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const newPhoto = {
                            id: Date.now() + Math.random(),
                            src: e.target.result,
                            name: file.name
                        };
                        
                        appState.photos.push(newPhoto);
                        renderPhotoGallery();
                        sessionStats.photosAdded++;
                        updateStats();
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            if (files.length > 0) {
                showNotification(`üì∏ ${files.length} photo(s) ajout√©e(s) !`, 'success');
            }
        }

        function renderPhotoGallery() {
            const container = document.getElementById('photoGrid');
            
            // Garder le bouton d'upload et ajouter les photos
            const uploadButton = container.querySelector('.photo-upload');
            container.innerHTML = '';
            container.appendChild(uploadButton);
            
            appState.photos.forEach(photo => {
                const photoCard = document.createElement('div');
                photoCard.className = 'photo-item';
                photoCard.innerHTML = `<img src="${photo.src}" alt="${photo.name}">`;
                photoCard.onclick = () => viewPhoto(photo);
                container.appendChild(photoCard);
            });
        }

        function viewPhoto(photo) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <h3>üì∏ ${photo.name}</h3>
                    <img src="${photo.src}" style="width: 100%; max-height: 500px; object-fit: contain; border-radius: 10px; margin: 20px 0;">
                    <button class="btn" onclick="this.closest('.modal').remove()">‚ùå Fermer</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // ========================
        // SYST√àME DE JEUX
        // ========================
        function refreshAllGames() {
            showNotification('üéÆ Jeux renouvel√©s !', 'success');
        }

        function randomGame() {
            const games = ['startMemoryGame', 'startQuizGame', 'startWordGame', 'startReactionGame'];
            const randomGameFunction = games[Math.floor(Math.random() * games.length)];
            eval(randomGameFunction + '()');
        }

        function startMemoryGame() {
            appState.currentGame = {
                type: 'memory',
                level: 1,
                items: ['üçé', 'üçä', 'üçå', 'üçá'],
                cards: [],
                flipped: [],
                matched: []
            };
            
            // Doubler les items et m√©langer
            appState.currentGame.cards = [...appState.currentGame.items, ...appState.currentGame.items]
                .sort(() => Math.random() - 0.5);
            
            showGameArea();
            renderMemoryGame();
            sessionStats.gamesPlayed++;
        }

        function renderMemoryGame() {
            const gridSize = Math.ceil(Math.sqrt(appState.currentGame.cards.length));
            
            document.getElementById('gameContent').innerHTML = `
                <h3 class="text-center mb-20">üß† Jeu de M√©moire</h3>
                <div class="memory-grid" style="grid-template-columns: repeat(${gridSize}, 1fr);" id="memoryGrid"></div>
            `;
            
            const grid = document.getElementById('memoryGrid');
            appState.currentGame.cards.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                
                if (appState.currentGame.flipped.includes(index) || appState.currentGame.matched.includes(index)) {
                    card.textContent = item;
                } else {
                    card.textContent = '?';
                }
                
                if (appState.currentGame.matched.includes(index)) {
                    card.classList.add('matched');
                }
                
                card.onclick = () => flipMemoryCard(index);
                grid.appendChild(card);
            });
        }

        function flipMemoryCard(index) {
            if (appState.currentGame.flipped.length < 2 && 
                !appState.currentGame.flipped.includes(index) && 
                !appState.currentGame.matched.includes(index)) {
                
                appState.currentGame.flipped.push(index);
                renderMemoryGame();
                
                if (appState.currentGame.flipped.length === 2) {
                    setTimeout(checkMemoryMatch, 1000);
                }
            }
        }

        function checkMemoryMatch() {
            const [first, second] = appState.currentGame.flipped;
            
            if (appState.currentGame.cards[first] === appState.currentGame.cards[second]) {
                appState.currentGame.matched.push(first, second);
                showNotification('‚úÖ Bonne paire !', 'success');
                
                if (appState.currentGame.matched.length === appState.currentGame.cards.length) {
                    showNotification('üéâ Jeu termin√© !', 'success');
                }
            }
            
            appState.currentGame.flipped = [];
            renderMemoryGame();
        }

        function startQuizGame() {
            const questions = [
                { q: "Quelle est la capitale de la France ?", options: ["Lyon", "Marseille", "Paris", "Toulouse"], correct: 2 },
                { q: "Combien font 7 x 8 ?", options: ["54", "56", "58", "60"], correct: 1 },
                { q: "Quel est l'animal le plus rapide ?", options: ["Gu√©pard", "Lion", "Antilope", "Faucon"], correct: 0 }
            ];
            
            appState.currentGame = {
                type: 'quiz',
                questions: questions,
                current: 0,
                score: 0
            };
            
            showGameArea();
            renderQuizGame();
            sessionStats.gamesPlayed++;
        }

        function renderQuizGame() {
            if (appState.currentGame.current >= appState.currentGame.questions.length) {
                document.getElementById('gameContent').innerHTML = `
                    <div class="text-center">
                        <h3>üéâ Quiz termin√© !</h3>
                        <p>Score: ${appState.currentGame.score}/${appState.currentGame.questions.length}</p>
                        <button class="btn" onclick="startQuizGame()">üîÑ Recommencer</button>
                    </div>
                `;
                return;
            }
            
            const question = appState.currentGame.questions[appState.currentGame.current];
            
            document.getElementById('gameContent').innerHTML = `
                <h3 class="text-center mb-20">‚ùì Quiz</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center;">
                    <h4>${question.q}</h4>
                </div>
                <div style="display: grid; gap: 10px; max-width: 400px; margin: 0 auto;" id="quizOptions"></div>
            `;
            
            const optionsDiv = document.getElementById('quizOptions');
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'btn secondary';
                button.textContent = option;
                button.onclick = () => answerQuiz(index, question.correct);
                optionsDiv.appendChild(button);
            });
        }

        function answerQuiz(selectedIndex, correctIndex) {
            if (selectedIndex === correctIndex) {
                appState.currentGame.score++;
                showNotification('‚úÖ Bonne r√©ponse !', 'success');
            } else {
                showNotification('‚ùå Mauvaise r√©ponse', 'error');
            }
            
            appState.currentGame.current++;
            setTimeout(renderQuizGame, 1500);
        }

        function startWordGame() {
            const words = ['FAMILLE', 'AMOUR', 'BONHEUR', 'SOURIRE'];
            const word = words[Math.floor(Math.random() * words.length)];
            const scrambled = word.split('').sort(() => Math.random() - 0.5).join('');
            
            appState.currentGame = {
                type: 'word',
                word: word,
                scrambled: scrambled
            };
            
            showGameArea();
            renderWordGame();
            sessionStats.gamesPlayed++;
        }

        function renderWordGame() {
            document.getElementById('gameContent').innerHTML = `
                <h3 class="text-center mb-20">üìù Mots M√©lang√©s</h3>
                <div style="text-align: center; margin: 30px 0;">
                    <div style="font-size: 2rem; letter-spacing: 3px; margin-bottom: 20px; background: #f0f0f0; padding: 20px; border-radius: 10px;">
                        ${appState.currentGame.scrambled}
                    </div>
                    <input type="text" id="wordGuess" placeholder="Votre r√©ponse..." style="padding: 10px; font-size: 1.2rem; text-align: center; margin: 10px;">
                    <br>
                    <button class="btn" onclick="checkWordGuess()">‚úÖ V√©rifier</button>
                    <button class="btn secondary" onclick="startWordGame()">üé≤ Nouveau mot</button>
                </div>
            `;
            
            document.getElementById('wordGuess').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkWordGuess();
            });
        }

        function checkWordGuess() {
            const guess = document.getElementById('wordGuess').value.trim().toUpperCase();
            
            if (guess === appState.currentGame.word) {
                showNotification('üéâ Bravo ! Mot trouv√© !', 'success');
                setTimeout(() => {
                    if (confirm('Jouer un autre mot ?')) {
                        startWordGame();
                    } else {
                        closeGame();
                    }
                }, 1500);
            } else {
                showNotification('‚ùå Pas encore...', 'error');
            }
        }

        function startReactionGame() {
            appState.currentGame = {
                type: 'reaction',
                waiting: false
            };
            
            showGameArea();
            renderReactionGame();
            sessionStats.gamesPlayed++;
        }

        function renderReactionGame() {
            document.getElementById('gameContent').innerHTML = `
                <h3 class="text-center mb-20">‚ö° Test de R√©flexes</h3>
                <div id="reactionArea" onclick="handleReactionClick()" style="
                    width: 100%; 
                    height: 300px; 
                    background: #e53e3e; 
                    border-radius: 20px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    font-size: 2rem; 
                    color: white; 
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">
                    <div>Cliquez quand c'est VERT !</div>
                </div>
                <div class="text-center mt-20">
                    <button class="btn secondary" onclick="startReactionRound()">üöÄ Commencer</button>
                </div>
            `;
        }

        function startReactionRound() {
            const reactionArea = document.getElementById('reactionArea');
            reactionArea.style.background = '#e53e3e';
            reactionArea.innerHTML = '<div>Attendez...</div>';
            appState.currentGame.waiting = false;
            
            const waitTime = 2000 + Math.random() * 3000;
            
            setTimeout(() => {
                reactionArea.style.background = '#48bb78';
                reactionArea.innerHTML = '<div>CLIQUEZ MAINTENANT !</div>';
                appState.currentGame.waiting = true;
                appState.currentGame.startTime = Date.now();
            }, waitTime);
        }

        function handleReactionClick() {
            if (appState.currentGame.waiting) {
                const reactionTime = Date.now() - appState.currentGame.startTime;
                document.getElementById('reactionArea').innerHTML = `<div>‚ö° ${reactionTime}ms !</div>`;
                appState.currentGame.waiting = false;
                
                let message = '';
                if (reactionTime < 300) message = 'üèÜ Excellent !';
                else if (reactionTime < 500) message = 'üëç Bien !';
                else message = 'üòÖ Pas mal !';
                
                showNotification(message, 'success');
            }
        }

        function showGameArea() {
            document.getElementById('gameArea').classList.add('active');
            document.getElementById('gameArea').scrollIntoView({ behavior: 'smooth' });
        }

        function closeGame() {
            document.getElementById('gameArea').classList.remove('active');
            appState.currentGame = null;
        }

        // ========================
        // VID√âOCONF√âRENCE
        // ========================
        async function startVideoCall() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('localVideo').srcObject = stream;
                appState.videoCall.localStream = stream;
                appState.videoCall.active = true;
                
                document.getElementById('startCallBtn').style.display = 'none';
                document.getElementById('endCallBtn').style.display = 'inline-block';
                document.getElementById('callStatus').textContent = 'Appel en cours...';
                
                // Simuler l'arriv√©e d'autres participants
                setTimeout(() => simulateParticipant('Papa'), 2000);
                setTimeout(() => simulateParticipant('Maman'), 4000);
                
                showNotification('üìπ Appel vid√©o d√©marr√© !', 'success');
                
            } catch (error) {
                console.error('Erreur cam√©ra:', error);
                showNotification('‚ùå Impossible d\'acc√©der √† la cam√©ra', 'error');
            }
        }

        function simulateParticipant(name) {
            const videoGrid = document.getElementById('videoGrid');
            
            const videoItem = document.createElement('div');
            videoItem.className = 'video-item';
            videoItem.innerHTML = `
                <div style="width: 100%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; border-radius: 15px;">
                    üë§ ${name}
                </div>
            `;
            
            videoGrid.appendChild(videoItem);
            appState.videoCall.participants.push({ name: name, element: videoItem });
            
            updateParticipantsList();
            showNotification(`üëã ${name} a rejoint l'appel`, 'info');
        }

        function endVideoCall() {
            if (appState.videoCall.localStream) {
                appState.videoCall.localStream.getTracks().forEach(track => track.stop());
            }
            
            document.getElementById('localVideo').srcObject = null;
            
            // Supprimer les participants simul√©s
            appState.videoCall.participants.forEach(participant => {
                participant.element.remove();
            });
            
            appState.videoCall.active = false;
            appState.videoCall.participants = [];
            
            document.getElementById('startCallBtn').style.display = 'inline-block';
            document.getElementById('endCallBtn').style.display = 'none';
            document.getElementById('callStatus').textContent = 'Pr√™t pour un appel vid√©o';
            
            updateParticipantsList();
            showNotification('üìû Appel termin√©', 'info');
        }

        function toggleMicrophone() {
            if (!appState.videoCall.localStream) return;
            
            const audioTrack = appState.videoCall.localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                const micBtn = document.getElementById('micBtn');
                micBtn.textContent = audioTrack.enabled ? 'üé§' : 'üîá';
                micBtn.classList.toggle('active', !audioTrack.enabled);
            }
        }

        function toggleCamera() {
            if (!appState.videoCall.localStream) return;
            
            const videoTrack = appState.videoCall.localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                const cameraBtn = document.getElementById('cameraBtn');
                cameraBtn.textContent = videoTrack.enabled ? 'üìπ' : 'üì∑';
                cameraBtn.classList.toggle('active', !videoTrack.enabled);
            }
        }

        async function shareScreen() {
            try {
                const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const localVideo = document.getElementById('localVideo');
                
                const originalStream = localVideo.srcObject;
                localVideo.srcObject = screenStream;
                
                screenStream.getVideoTracks()[0].addEventListener('ended', () => {
                    localVideo.srcObject = originalStream;
                    showNotification('üñ•Ô∏è Partage d\'√©cran arr√™t√©', 'info');
                });
                
                showNotification('üñ•Ô∏è Partage d\'√©cran d√©marr√©', 'success');
                
            } catch (error) {
                showNotification('‚ùå Partage d\'√©cran impossible', 'error');
            }
        }

        function updateParticipantsList() {
            const list = appState.videoCall.participants.map(p => p.name).join(', ');
            document.getElementById('participantsList').textContent = 
                list ? `Participants: ${list}` : 'En attente de participants';
        }

        // ========================
        // PARAM√àTRES ET UTILITAIRES
        // ========================
        function loadSettings() {
            if (currentFamily) {
                document.getElementById('settingsFamilyName').value = currentFamily;
            }
            if (currentUser) {
                document.getElementById('settingsUserName').value = currentUser;
            }
        }

        function saveSettings() {
            showNotification('‚úÖ Param√®tres sauvegard√©s !', 'success');
        }

        function exportData() {
            const exportData = {
                family: currentFamily,
                user: currentUser,
                photos: appState.photos,
                sessionStats: sessionStats,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `famille-connect-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('üíæ Donn√©es export√©es !', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (importedData.photos) {
                                appState.photos = importedData.photos;
                                renderPhotoGallery();
                            }
                            showNotification('‚úÖ Donn√©es import√©es !', 'success');
                        } catch (error) {
                            showNotification('‚ùå Erreur d\'import', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function resetApp() {
            if (confirm('‚ö†Ô∏è R√©initialiser l\'application ?')) {
                localStorage.clear();
                location.reload();
            }
        }

        function disconnect() {
            if (confirm('Voulez-vous vraiment quitter la famille ?')) {
                updateUserOnlineStatus(false);
                
                if (messagesSubscription) messagesSubscription.unsubscribe();
                if (membersSubscription) membersSubscription.unsubscribe();
                
                localStorage.removeItem('familyCode');
                localStorage.removeItem('userName');
                
                currentFamily = null;
                currentUser = null;
                
                document.getElementById('appArea').classList.remove('active');
                document.getElementById('connectionSetup').style.display = 'block';
                
                showNotification('üëã Vous avez quitt√© la famille', 'info');
            }
        }

        function updateStats() {
            document.getElementById('totalMembers').textContent = appState.members.length;
            document.getElementById('onlineMembers').textContent = appState.members.filter(m => {
                const lastSeen = new Date(m.last_seen);
                const now = new Date();
                return (now - lastSeen) < 2 * 60 * 1000;
            }).length;
            
            // Compter les messages (simulation)
            const messagesCount = document.getElementById('chatMessages').children.length;
            document.getElementById('totalMessages').textContent = messagesCount;
            document.getElementById('totalPhotos').textContent = appState.photos.length;
            
            // Stats de session
            document.getElementById('messagesSent').textContent = sessionStats.messagesSent;
            document.getElementById('gamesPlayed').textContent = sessionStats.gamesPlayed;
            document.getElementById('photosAdded').textContent = sessionStats.photosAdded;
        }

        function updateSessionTimer() {
            if (!sessionStartTime) return;
            
            setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('sessionDuration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // ========================
        // FONCTIONS UTILITAIRES
        // ========================
        function generateFamilyCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'FAM';
            for (let i = 0; i < 5; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showFamilyCode() {
            const message = `üîë Code de votre famille: ${currentFamily}\n\nüìã Partagez ce code avec votre famille pour qu'ils puissent vous rejoindre !`;
            alert(message);
        }

        function copyFamilyCode() {
            const textToCopy = `üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Rejoignez notre famille sur Famille Connect Pro !\n\nüîë Code: ${currentFamily}\n\nUtilisez ce code pour nous rejoindre !`;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                showNotification('üìã Code copi√© !', 'success');
            }).catch(() => {
                prompt('Copiez ce texte:', textToCopy);
            });
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const indicator = document.getElementById('connectionIndicator');
            
            if (connected) {
                status.textContent = 'üü¢ Connect√©';
                status.className = 'connection-status';
                if (indicator) indicator.textContent = 'üü¢ Connect√©';
            } else {
                status.textContent = 'üî¥ D√©connect√©';
                status.className = 'connection-status disconnected';
                if (indicator) indicator.textContent = 'üî¥ D√©connect√©';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            
            notification.className = `notification ${type} show`;
            notification.textContent = message;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function setLoading(loading) {
            const elements = document.querySelectorAll('.btn');
            elements.forEach(btn => {
                btn.disabled = loading;
                if (loading) {
                    btn.classList.add('loading');
                } else {
                    btn.classList.remove('loading');
                }
            });
        }

        // ========================
        // INITIALISATION AUTOMATIQUE
        // ========================
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Famille Connect Pro - D√©marrage');
            
            if (initializeSupabase()) {
                const connected = await testSupabaseConnection();
                if (connected) {
                    showNotification('‚úÖ Application pr√™te !', 'success');
                    checkExistingSession();
                } else {
                    showNotification('‚ùå Probl√®me de connexion', 'error');
                }
            }
        });

        // ========================
        // GESTION DES √âV√âNEMENTS
        // ========================
        
        // Gestion de la fermeture de la page
        window.addEventListener('beforeunload', () => {
            if (currentFamily && currentUser) {
                updateUserOnlineStatus(false);
            }
        });

        // Gestion de la visibilit√© de la page
        document.addEventListener('visibilitychange', () => {
            if (currentFamily && currentUser) {
                updateUserOnlineStatus(!document.hidden);
            }
        });

        // Gestion des clics sur les modales
        window.addEventListener('click', (event) => {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        // Gestion du clavier
        document.addEventListener('keydown', (event) => {
            // Escape pour fermer les modales et jeux
            if (event.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => modal.classList.remove('show'));
                
                if (appState.currentGame) {
                    closeGame();
                }
            }
            
            // Ctrl+S pour sauvegarder
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault();
                exportData();
            }
        });

        // D√©tection de la connexion r√©seau
        window.addEventListener('online', () => {
            updateConnectionStatus(true);
            showNotification('üü¢ Connexion r√©tablie', 'success');
        });

        window.addEventListener('offline', () => {
            updateConnectionStatus(false);
            showNotification('üî¥ Connexion perdue', 'warning');
        });

        // ========================
        // FONCTIONS SUPPL√âMENTAIRES
        // ========================
        
        // Fonction pour redimensionner automatiquement les √©l√©ments
        function handleResize() {
            // Ajuster la taille du chat sur mobile
            if (window.innerWidth <= 768) {
                const chatContainer = document.querySelector('.chat-container');
                if (chatContainer) {
                    chatContainer.style.height = '300px';
                }
            }
        }

        window.addEventListener('resize', handleResize);

        // Fonction pour d√©tecter les appareils tactiles
        function isTouchDevice() {
            return (('ontouchstart' in window) ||
                   (navigator.maxTouchPoints > 0) ||
                   (navigator.msMaxTouchPoints > 0));
        }

        // Adapter l'interface pour les appareils tactiles
        if (isTouchDevice()) {
            document.body.classList.add('touch-device');
            
            // Ajouter des styles sp√©cifiques pour le tactile
            const style = document.createElement('style');
            style.textContent = `
                .touch-device .btn {
                    min-height: 44px;
                    padding: 15px 25px;
                }
                
                .touch-device .nav-tab {
                    padding: 15px 16px;
                }
                
                .touch-device .memory-card {
                    min-height: 60px;
                }
                
                .touch-device .video-control-btn {
                    padding: 15px;
                    min-width: 50px;
                    min-height: 50px;
                }
            `;
            document.head.appendChild(style);
        }

        // Fonction de d√©buggage (√† supprimer en production)
        function debugInfo() {
            console.log('=== DEBUG FAMILLE CONNECT ===');
            console.log('Famille actuelle:', currentFamily);
            console.log('Utilisateur actuel:', currentUser);
            console.log('√âtat de l\'app:', appState);
            console.log('Stats session:', sessionStats);
            console.log('Supabase connect√©:', !!supabase);
            console.log('==============================');
        }

        // Rendre debugInfo accessible globalement (pour tests)
        window.debugFamilleConnect = debugInfo;

        // ========================
        // AM√âLIORATIONS UX
        // ========================
        
        // Pr√©loader pour les images
        function preloadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = resolve;
                img.onerror = reject;
                img.src = src;
            });
        }

        // Fonction pour optimiser les performances
        function optimizePerformance() {
            // Limiter le nombre de messages affich√©s
            const maxMessages = 50;
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages && chatMessages.children.length > maxMessages) {
                const messagesToRemove = chatMessages.children.length - maxMessages;
                for (let i = 0; i < messagesToRemove; i++) {
                    chatMessages.removeChild(chatMessages.firstChild);
                }
            }
            
            // Limiter le nombre de photos en m√©moire
            const maxPhotos = 20;
            if (appState.photos.length > maxPhotos) {
                appState.photos = appState.photos.slice(-maxPhotos);
                renderPhotoGallery();
            }
        }

        // Ex√©cuter l'optimisation p√©riodiquement
        setInterval(optimizePerformance, 60000); // Toutes les minutes

        // ========================
        // FONCTIONS DE VALIDATION
        // ========================
        
        function validateFamilyCode(code) {
            return /^FAM[A-Z0-9]{5}$/.test(code);
        }

        function validateUserName(name) {
            return name && name.trim().length >= 2 && name.trim().length <= 20;
        }

        function sanitizeInput(input) {
            return input.trim().replace(/[<>]/g, '');
        }

        // ========================
        // SYST√àME DE CACHE SIMPLE
        // ========================
        
        const cache = {
            familyData: null,
            members: null,
            lastUpdate: null,
            
            set(key, data) {
                this[key] = data;
                this.lastUpdate = Date.now();
            },
            
            get(key, maxAge = 30000) { // 30 secondes par d√©faut
                if (this.lastUpdate && Date.now() - this.lastUpdate < maxAge) {
                    return this[key];
                }
                return null;
            },
            
            clear() {
                this.familyData = null;
                this.members = null;
                this.lastUpdate = null;
            }
        };

        // ========================
        // FINALISATION
        // ========================
        
        console.log('üéâ Famille Connect Pro - Charg√© avec succ√®s !');
        console.log('üì± Version: 1.0.0 Final');
        console.log('üîó Supabase: Int√©gr√©');
        console.log('üéÆ Jeux: 4 jeux disponibles');
        console.log('üìπ Vid√©o: WebRTC int√©gr√©');
        console.log('üì∏ Photos: Support complet');
        console.log('üí¨ Chat: Temps r√©el');
        
        // Message de bienvenue dans la console
        console.log('%cüë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famille Connect Pro', 'color: #667eea; font-size: 24px; font-weight: bold;');
        console.log('%cApplication familiale compl√®te avec synchronisation temps r√©el', 'color: #718096; font-size: 14px;');
    </script>
</body>
</html>
